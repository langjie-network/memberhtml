<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, width=device-width, initial-scale=1.0">
    <title>车辆详情</title>
    <script type="text/javascript" src="https://langjie.oss-cn-hangzhou.aliyuncs.com/space/root/project/viphelp/js/lib/vue3/vue@2.js"></script>
    <script src="../../../js/kendo/jquery.min.js" type="text/javascript"></script>
    <script src="../../../js/common.js" type="text/javascript"></script>
    <script src="../../common/lib/ming_mock/m_staff_request.js" type="text/javascript"></script>
    <script src="./server.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/2.0.1/weui.min.css">
    <style>
        body {
            background-color: #f7f7f7;
        }
        .weui-cell {
            background-color: #fff;
        }
        .submit-button {
            margin: 20px;
            background-color: #1aad19;
            color: #fff;
        }
        .delete-button {
            margin: 20px;
            background-color: #f44336;
            color: #fff;
        }
        .image-upload {
            margin: 20px;
            text-align: center;
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
        }
        .image-upload img {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
        }
        .upload-icon {
            font-size: 50px;
            color: #ccc;
        }
        .button-container {
            display: flex;
            justify-content: center; /* Center the buttons */
            margin: 20px 0; /* Add some margin */
        }
        .weui-cell__ft input {
            width: 100%;
            padding: 10px;
            border: none; /* Remove border */
            border-radius: 5px;
            background-color: #f7f7f7; /* Optional: match background */
            outline: none; /* Remove outline on focus */
        }
        .map-icon {
            width: 20px; /* Adjust size as needed */
            height: 20px; /* Adjust size as needed */
            margin-left: 5px; /* Space between text and icon */
            vertical-align: middle; /* Align icon with text */
        }
    </style>
</head>
<body>
<div id="main">
    <div class="weui-panel">
        <div class="weui-panel__hd">详情</div>
        <div class="weui-panel__bd">
            <div class="weui-cell">
                <div class="weui-cell__bd">使用人</div>
                <div class="weui-cell__ft">{{ user_name }}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__bd">类型</div>
                <div class="weui-cell__ft" style="display: flex;justify-content: left">
                    <label class="weui-cell ">
                        <input style="width: 10vw"  type="radio" value="1" v-model="is_pub">公用
                    </label>
                    <label class="weui-cell ">
                        <input style="width: 10vw" type="radio" value="0" v-model="is_pub">私用
                    </label>
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__bd">车牌号</div>
                <div class="weui-cell__ft">{{ car_no }}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__bd">拿车时间</div>
                <div class="weui-cell__ft">
                    <input style="width: 30vw" type="datetime-local" v-model="take_time" />
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__bd">还车时间</div>
                <div class="weui-cell__ft">
                    <input style="width: 30vw" type="datetime-local" v-model="back_time" />
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__bd">拿车位置</div>
                <div class="weui-cell__ft">{{ take_gps }}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__bd">还车位置</div>
                <div class="weui-cell__ft">
                    {{ back_gps }}  <span  @click="getBackGps"> 🗺️</span>
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__bd">拿车行程</div>
                <div class="weui-cell__ft">
                    <input type="number" v-model="take_mile" placeholder="请输入拿车行程" />
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__bd">还车行程</div>
                <div class="weui-cell__ft">
                    <input type="number" v-model="back_mile" placeholder="请输入还车行程" />
                </div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__bd">本次行程</div>
                <div class="weui-cell__ft">{{ this.back_mile - this.take_mile }}</div>
            </div>
            <div class="weui-cell">
                <div class="weui-cell__bd">原因</div>
                <div class="weui-cell__ft">
                    <input type="text" v-model="reason" placeholder="请输入原因" />
                </div>
            </div>
        </div>
    </div>
    <div class="weui-panel">
        <div class="weui-panel__bd">
            <div class="image-upload" @click="$refs.fileInput.click()">
                <input type="file" ref="fileInput" @change="onFileChange($event,'take_img')" accept="image/*" style="display: none;" />
                <div class="upload-icon">+</div>
                <p>拿车图</p>
                <div class="image-preview" v-if="take_img">
                    <img :src="take_img" alt="Pick-up Image" />
                </div>
            </div>
            <div class="image-upload" @click="$refs.fileInput1.click()">
                <input type="file" ref="fileInput1" @change="onFileChange($event,'back_img')" accept="image/*" style="display: none;" />
                <div class="upload-icon">+</div>
                <p>还车图</p>
                <div class="image-preview" v-if="back_img">
                    <img :src="back_img" alt="Pick-up Image" />
                </div>
            </div>
        </div>
    </div>
    <div class="button-container">
        <button class="weui-btn weui-btn_primary submit-button" @click="submit">提交</button>
        <button class="weui-btn weui-btn_default delete-button" @click="deleteRecord">删除</button>
    </div>
</div>

<script>
    const BASE_IMG = img => 'https://langjie.oss-cn-hangzhou.aliyuncs.com/public/img/gallery/' + img;

    new Vue({
        el: '#main',
        data: {
            user_name: '',
            car_no: '',
            take_gps: "",
            back_gps: "",
            take_time: '', // Default value for pick-up time
            back_time: '', // Default value for return time
            reason: '',
            use_mile: '',
            take_mile: '',
            back_mile: '',
            take_img: null,
            back_img: null,
            take_img_temp: null,
            back_img_temp: null,
            is_pub:1,
            typeOptions: [
                { value: 1, label: '公用' },
                { value: 0, label: '私用' }
            ]
        },
        methods: {
            async getBackGps() {
                try{
                    const r = await M.getLocation();
                    this.back_gps=`${r[0].toFixed(3)},${r[1].toFixed(3)}`;
                }catch(e){
                    alert(e.message);
                }       
     
            },
            async onFileChange(event, imgType) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this[imgType] = e.target.result; // Set the image URL for preview
                    };
                    reader.readAsDataURL(file); // Read the file as a data URL
                }
                const r = await MIO.member_ajax_ossUpload({
                    file: file
                });
                this[imgType+"_temp"] =r.expressResult[0];
                alert(r.expressResult[0])
            },
            async submit() {
                  const r=await  MIO.vehicleRegistUpdate({
                        id: M.getPageParam().v_id,
                        take_mile: this.take_mile,
                        take_time:this.take_time,
                        back_mile: this.back_mile,
                        back_time: this.back_time,
                        back_gps: this.back_gps,
                        reason: this.reason,
                        take_img: this.take_img_temp,
                        back_img: this.back_img_temp,
                        reason: this.reason,
                        is_pub: this.is_pub,
                    });
                   if(r.code===200){
                       wxToast("修改成功");
                       location.href="/memberhtml/pages/vehicle_regist/index.html";
                       return;
                   }else {
                       wxToast(r.msg);
                   }
            },
            async deleteRecord() {
                let r= window.confirm("确定删除");
                if(r){
                   const ret=await  MIO.vehicleRegistDelete({v_id: M.getPageParam().v_id})
                   if(M.checkR(ret)){
                       wxToast("删除成功");
                       location.href="/memberhtml/pages/vehicle_regist/index.html";
                       return;
                   }else {
                       wxToast(ret.msg);
                   }

                }
                // 在这里添加删除逻辑
            }
        },
        async mounted() {
            const r = await MIO.vehicleRegistGetRecordById({
                v_id: M.getPageParam().v_id
            });
            let record = r.data;
            this.user_name = record.user_name;
            this.car_no = record.car_no;
            this.take_time = new Date(record.take_time).format("yyyy-MM-ddThh:mm");
            if(record.back_time){
                this.back_time = new Date(record.back_time).format("yyyy-MM-ddThh:mm");
            }else {
                this.back_time = new Date().format("yyyy-MM-ddThh:mm");
            }
            this.take_img = BASE_IMG(record.take_img);
            this.back_img = BASE_IMG(record.back_img);
            this.take_img_temp = record.take_img;
            this.back_img_temp = record.back_img;
            this.take_gps =record.take_gps;
            this.back_gps =record.back_gps;
            this.back_mile = record.back_mile;
            this.take_mile = record.take_mile;
            this.reason = record.reason;
            this.is_pub = record.is_pub;
        }
    });
</script>
</body>
</html>
