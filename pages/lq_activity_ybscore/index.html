<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0">
    <title>我的钱包</title>
    <script src="/js/aui/aui-pull-refresh.js"></script>
    <script type="text/javascript" src="https://res.wx.qq.com/t/wx_fed/cdn_libs/res/weui/1.2.3/weui.min.js"></script>
    <script type="text/javascript" src="https://langjie.oss-cn-hangzhou.aliyuncs.com/space/root/project/viphelp/js/lib/vue3/vue@2.js"></script>
    <script src="/js/kendo/jquery.min.js" type="text/javascript"></script>
    <script src="/js/common.js" type="text/javascript"></script>
    <script src="/js/request.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/memberhtml/pages/lq_activity_ybscore/index.css">
    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/2.0.1/weui.min.css">
</head>
<body>
<div id="main">
    <div class="weui-tab" id="tab">
        <div class="weui-navbar">
            <div class="weui-navbar__item">元宝分</div>
            <div class="weui-navbar__item">参与券</div>
            <div class="weui-navbar__item">提货券</div>
        </div>
        <div class="weui-tab__panel">
            <div class="weui-tab__content">
                <div class="weui-form-preview">
                    <div class="weui-form-preview__hd">
                        <div class="weui-form-preview__item">
                            <label class="weui-form-preview__label">可用分</label>
                            <em class="weui-form-preview__value total_amount ticketScore">{{ticketScore}}</em>
                        </div>
                    </div>
                    <div class="weui-panel__ft">
                        <a href="javascript:void(0);" class="weui-cell weui-cell_access weui-cell_link" onclick="exchangeGoods();">
                            <div class="weui-cell__bd" style="font-size: 1.2rem;">兑换礼品</div>
                            <span class="weui-cell__ft"></span>
                        </a>
                    </div>
                </div>
                <div class="weui-cells__title">积分明细</div><div class="weui-cells"></div>
                <div v-if="ticketList.length>0">
                    <a v-for="item in ticketList"  class="weui-cell" href="javascript:;">
                        <div class="weui-cell__bd">
                            <p>
                            <p style="color: #000;">{{item.rem}}</p>
                            <p style="color: #999;">{{item.create_time}}</p>
                            </p>
                        </div>
                        <div class="weui-cell__ft">
                            <p>{{item.score}}分</p>
                        </div>
                    </a>
                </div>
                <div v-else class="weui-loadmore weui-loadmore_line">
                    <span class="weui-loadmore__tips">暂无数据</span>
                </div>
            </div>
            <div class="weui-tab__content">
                <div class="weui-form-preview">
                    <div class="weui-form-preview__hd">
                        <div class="weui-form-preview__item">
                            <label class="weui-form-preview__label">待领取/总数</label>
                            <em class="weui-form-preview__value total_amount ticketScore">{{participate_voucher_dailingquCount}}/{{participate_voucher_recordList.length}}</em>
                        </div>
                    </div>
                </div>
                <div class="weui-cells__title">参与券明细</div><div class="weui-cells"></div>
                <div v-if="ticketList.length>0">
                    <a v-for="item in participate_voucher_recordList"  class="weui-cell" href="javascript:;">
                        <div class="weui-cell__bd">
                            <p>
                            <p style="color: #000;">{{item.voucher_name}}</p>
                            <p style="color: #999;">{{item.gmt_create}}</p>
                            </p>
                        </div>
                        <div class="weui-cell__ft">
                            <p>{{item.state}}</p>
                        </div>
                    </a>
                </div>
                <div v-else class="weui-loadmore weui-loadmore_line">
                    <span class="weui-loadmore__tips">暂无数据</span>
                </div>
            </div>
            <div class="weui-tab__content">
                <div class="weui-form-preview">
                    <div class="weui-form-preview__hd">
                        <div class="weui-form-preview__item">
                            <label class="weui-form-preview__label">待使用/总数</label>
                            <em class="weui-form-preview__value total_amount ticketScore">5/{{8}}</em>
                        </div>
                    </div>
                </div>
                <div class="weui-cells__title">提货券明细</div><div class="weui-cells ticketList"></div>
                <div v-if="ticketList.length>0">
                    <a v-for="item in ticketList"  class="weui-cell" href="javascript:;">
                        <div class="weui-cell__bd">
                            <p>
                            <p style="color: #000;">{{item.rem}}</p>
                            <p style="color: #999;">{{item.create_time}}</p>
                            </p>
                        </div>
                        <div class="weui-cell__ft">
                            <p>{{item.score}}分</p>
                        </div>
                    </a>
                </div>
                <div v-else class="weui-loadmore weui-loadmore_line">
                    <span class="weui-loadmore__tips">暂无数据</span>
                </div>
            </div>
        </div>
    </div>
    <div class="msg-foot">

    </div>
</div>
</body>

</html>

<template id="msgItemTemplateId">
    <div class="msgItemWrap">
        A
    </div>
</template>


<script>
    var g_ticketList_page = 0, g_ticketList_pageSize = 10;
    var g_ticketList_isLoading = false, g_ticketList_hasMore = true;
    app.get("/lq_activity_ybscore_list_getScoreTicketByUid",async (req,res)=>{
        g_ticketList_isLoading = true;
        g_ticketList_page++;
        $.ajax({
            url: route('member/getScoreTicketByUid'),
            type: 'get',
            data: {
                page: g_ticketList_page,
                pageSize: g_ticketList_pageSize,
            },
            success: function (res1) {
                g_ticketList_isLoading = false;
                if (res1.data.ticketList.length === 0) {
                    g_ticketList_hasMore = false;
                }
                res.send(res1.data);
            }
        });
    })


    app.get("/lq_activity_ybscore_list_getLqActivityVoucherRecordList",async (req,res)=>{
        let {lq_voucher_category}=req.params;
        $.ajax({
            url: route('member/getLqActivityVoucherRecordList'),
            type: 'get',
            data: {
                page: 1,
                pageSize: 20,
                lq_voucher_category
            },
            success: function (res1) {
                res.send(res1.data);
            }
        });
    })



    function exchangeGoods() {
        window.location.href = route('member/exchangeGoodsList');
    }



    window.onload = function () {
        M.vueApp = new Vue({
            el: "#main",
            data: {
                tab:0,
                //元宝分消费列表
                ticketList: [],
                ticketScore:0,
                participate_voucher_recordList:[],

            },
            async mounted() {
                let that=this;
                weui.tab('#tab',{
                    defaultIndex: 0,
                    onChange: async function(index){
                        that.tab=index;
                    }
                });
                this.fetchTicket();
                that.fetchParticipateVoucherRecordList();


            },

            methods: {
                async fetchTicket(){
                    let ticketListResult=await MIO.lq_activity_ybscore_list_getScoreTicketByUid();
                    this.ticketScore=ticketListResult.ticketScore;
                    let newticketList=ticketListResult.ticketList;
                    if(g_ticketList_page>0){
                        this.ticketList=[...this.ticketList,...newticketList]
                    }else {
                        this.ticketList=newticketList
                    }
                },
                async fetchParticipateVoucherRecordList(){
                    let list=  await MIO.lq_activity_ybscore_list_getLqActivityVoucherRecordList({lq_voucher_category:'participate'})
                    this.participate_voucher_recordList=list;
                },
                getItemState(state) {

                }
            },
            updated(){

            },
            computed: {
                participate_voucher_dailingquCount() {
                    let list=  this.participate_voucher_recordList.filter(u=>u.state=="待兑换")
                    return list.length;
                }
            },
        });
    }


    window.onscroll = function() {
        var s_height = document.documentElement.scrollTop || $('body').scrollTop();
        var b_height = $('body').height();
        var height = window.innerHeight;
        if (b_height - height - s_height < 20) {
            if (!g_ticketList_isLoading && g_ticketList_hasMore && M.vueApp.tab==0) {
                M.vueApp.fetchTicket();
            }
        }
    }
</script>

